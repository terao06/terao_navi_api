openapi: 3.0.3
info:
  title: Terao Navi API
  description: |
    LLMとベクトルデータベースを活用した質問応答システムを提供するナビゲーションAPIです。
    
    ## 認証方式
    
    このAPIは2段階の認証方式を採用しています：
    
    ### 1. トークン発行（`/auth/token`）
    - **カスタムヘッダー認証**を使用してクライアント認証
    - ヘッダー:
      - `X-Origin`: リクエスト元のオリジン（例: `https://your-website.com`）
      - `X-Company-Id`: 企業ID（例: `1`）
    - データベースに登録された企業情報と照合し、Originがホームページと一致することを確認
    
    ### 2. API呼び出し（`/ask`など）
    - **Bearer Token認証**を使用
    - トークン: `/auth/token`で取得した`access_token`
    - ヘッダー: `Authorization: Bearer {access_token}`
    
    ### 3. トークン更新（`/auth/refresh`）
    - **Bearer Token認証**を使用
    - トークン: `/auth/token`で取得した`refresh_token`
    - ヘッダー: `Authorization: Bearer {refresh_token}`
    
    ## 認証フロー
    
    1. `/auth/token`でカスタムヘッダー認証（X-Origin, X-Company-Id）により`access_token`と`refresh_token`を取得
    2. 取得した`access_token`を使用してAPI（`/ask`など）を呼び出し
    3. `access_token`の有効期限が切れたら、`refresh_token`を使用して`/auth/refresh`で新しいトークンペアを取得
    
    ## 初期データ
    
    開発環境では、MySQLデータベースに企業情報（company_id、home_page等）を登録する必要があります。
    詳細は `local_setting/local_mysql/init.sql` を参照してください。
    
  version: 1.0.0
  contact:
    name: API Support
    email: support@example.com
  license:
    name: Proprietary
    
servers:
  - url: http://localhost:8005
    description: ローカル開発環境
  - url: https://api.example.com
    description: 本番環境

tags:
  - name: Authentication
    description: 認証・トークン管理に関するエンドポイント
  - name: Question
    description: 質問応答に関するエンドポイント

paths:
  /auth/token:
    post:
      tags:
        - Authentication
      summary: アクセストークンとリフレッシュトークンを発行
      description: |
        カスタムヘッダー認証を使用してクライアント認証を行い、アクセストークンとリフレッシュトークンを発行します。
        
        ### 認証方式
        - **カスタムヘッダー認証**を使用
        - **X-Origin**: リクエスト元のオリジン（例: `https://your-website.com`）
        - **X-Company-Id**: 企業ID（例: `1`）
        
        ### 処理フロー
        1. リクエストヘッダーから`X-Origin`と`X-Company-Id`を取得
        2. MySQLデータベースから`company_id`に対応する企業情報を取得
        3. `X-Origin`と企業のホームページ（`home_page`）が一致するかを検証
        4. 検証成功後、アクセストークン（短命）とリフレッシュトークン（長命）を生成
        5. 両方のトークンと有効期限情報を返却
        
      operationId: issueToken
      security:
        - apiKeyAuth: []
      parameters:
        - in: header
          name: X-Origin
          required: true
          schema:
            type: string
            example: "https://your-website.com"
          description: |
            リクエスト元のオリジン
            
            企業のホームページとして登録されているURLと一致する必要があります。
            
            例: `https://your-website.com`
        - in: header
          name: X-Company-Id
          required: true
          schema:
            type: integer
            example: 1
          description: |
            企業ID
            
            MySQLデータベースに登録されている企業のIDを指定します。
            
            例: `1`
      responses:
        '200':
          description: トークン発行成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
              examples:
                success:
                  summary: 成功時のレスポンス
                  value:
                    status: "success"
                    data:
                      access_token: "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9..."
                      expires_at: "2026-01-18T12:30:00Z"
                      ttl_seconds: 3600
                      refresh_token: "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9..."
                      refresh_expires_at: "2026-02-17T11:30:00Z"
                      refresh_ttl_seconds: 2592000
        '401':
          description: 認証エラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                unauthorized:
                  summary: 認証失敗
                  value:
                    status: "error"
                    message: "認証に失敗しました。"
                    error_code: "UNAUTHORIZED"
        '403':
          description: アクセス拒否（無効化されたクライアント）
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                forbidden:
                  summary: クライアントが無効化されている
                  value:
                    status: "error"
                    message: "認証に失敗しました。"
                    error_code: "FORBIDDEN"
        '500':
          description: サーバーエラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/refresh:
    post:
      tags:
        - Authentication
      summary: リフレッシュトークンを使用して新しいトークンペアを発行
      description: |
        リフレッシュトークンを使用して、新しいアクセストークンとリフレッシュトークンのペアを発行します。
        
        ### 認証方式
        - Bearer Token認証を使用
        - トークン: refresh_token（/auth/tokenで取得したもの）
        
        ### 処理フロー
        1. リフレッシュトークンの署名と有効期限を検証
        2. トークンからcompany_idを抽出
        3. 新しいアクセストークンとリフレッシュトークンを生成（トークンローテーション）
        4. 両方のトークンと有効期限情報を返却
        
        ### セキュリティ
        - リフレッシュトークンは使用後に新しいものに置き換えられます（トークンローテーション）
        - 古いリフレッシュトークンは使用できなくなります
        
      operationId: refreshToken
      security:
        - bearerAuth: []
      parameters:
        - in: header
          name: Authorization
          required: true
          schema:
            type: string
            example: "Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJyYW5kb20iOiJhYmMxMjMiLCJleHAiOjE3MDUzMjAwMDAsImNvbXBhbnlfaWQiOjF9.signature"
          description: |
            Bearer Token認証ヘッダー（リフレッシュトークン）
            
            形式: `Bearer {refresh_token}`
            
            `/auth/token`エンドポイントで取得した`refresh_token`を使用してください。
            
            例: `Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...`
      responses:
        '200':
          description: トークン更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
              examples:
                success:
                  summary: 成功時のレスポンス
                  value:
                    status: "success"
                    data:
                      access_token: "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9..."
                      expires_at: "2026-01-18T12:30:00Z"
                      ttl_seconds: 3600
                      refresh_token: "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9..."
                      refresh_expires_at: "2026-02-17T11:30:00Z"
                      refresh_ttl_seconds: 2592000
        '401':
          description: 認証エラー（無効なトークンまたは有効期限切れ）
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalid_token:
                  summary: 無効なトークン
                  value:
                    status: "error"
                    message: "認証に失敗しました。"
                    error_code: "UNAUTHORIZED"
                expired_token:
                  summary: 有効期限切れ
                  value:
                    status: "error"
                    message: "トークンの有効期限が切れています。"
                    error_code: "TOKEN_EXPIRED"
        '500':
          description: サーバーエラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /ask:
    post:
      tags:
        - Question
      summary: 質問を送信して回答を取得
      description: |
        ユーザーからの質問を受け取り、LLMとベクトルデータベースを使用して適切な回答を生成します。
        
        ### 処理フロー
        1. 質問内容をベクトル化
        2. ベクトルデータベースから関連情報を検索
        3. LLMを使用して回答を生成
        4. 回答を返却
        
      operationId: askQuestion
      security:
        - bearerAuth: []
      parameters:
        - in: header
          name: Authorization
          required: true
          schema:
            type: string
            example: "Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJyYW5kb20iOiJhYmMxMjMiLCJleHAiOjE3MDUzMjAwMDAsImNvbXBhbnlfaWQiOjF9.signature"
          description: |
            Bearer Token認証ヘッダー（アクセストークン）
            
            形式: `Bearer {access_token}`
            
            `/auth/token`エンドポイントで取得した`access_token`を使用してください。
            
            例: `Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...`
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/QuestionRequest'
            examples:
              basic:
                summary: 基本的な質問
                value:
                  question: "この製品の使い方を教えてください"
              with_app_id:
                summary: アプリケーションIDを指定した質問
                value:
                  application_id: 1
                  question: "トラブルシューティングの方法は？"
      responses:
        '200':
          description: 成功レスポンス
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QuestionResponse'
              examples:
                success:
                  summary: 成功時のレスポンス
                  value:
                    status: "success"
                    data:
                      answer: "製品の使い方については、以下の手順に従ってください..."
        '400':
          description: リクエストエラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalid_request:
                  summary: 不正なリクエスト
                  value:
                    status: "error"
                    message: "質問内容が空です"
                    error_code: "INVALID_REQUEST"
        '401':
          description: 認証エラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                unauthorized:
                  summary: 認証失敗
                  value:
                    status: "error"
                    message: "認証に失敗しました"
                    error_code: "UNAUTHORIZED"
        '500':
          description: サーバーエラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                server_error:
                  summary: サーバー内部エラー
                  value:
                    status: "error"
                    message: "内部エラーが発生しました"
                    error_code: "INTERNAL_SERVER_ERROR"

  /health:
    get:
      tags:
        - Health
      summary: ヘルスチェック
      description: APIサーバーの稼働状態を確認します
      operationId: healthCheck
      responses:
        '200':
          description: サーバーが正常に稼働中
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "healthy"
                  timestamp:
                    type: string
                    format: date-time
                    example: "2026-01-12T10:30:00Z"

components:
  securitySchemes:
    apiKeyAuth:
      type: apiKey
      in: header
      name: X-Origin and X-Company-Id
      description: |
        カスタムヘッダー認証
        
        **必要なヘッダー**:
        - `X-Origin`: リクエスト元のオリジン（例: `https://your-website.com`）
        - `X-Company-Id`: 企業ID（例: `1`）
        
        **検証プロセス**:
        1. リクエストヘッダーから`X-Origin`と`X-Company-Id`を抽出
        2. MySQLデータベースから`company_id`に対応する企業情報を取得
        3. 企業情報が存在することを確認
        4. `X-Origin`と企業のホームページ（`home_page`カラム）が一致することを確認
        5. 検証成功後、company_idを返却
        
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        Bearer Token認証
        
        形式: `Authorization: Bearer {token}`
        
        `/ask`エンドポイントではaccess_tokenを使用します。
        `/auth/refresh`エンドポイントではrefresh_tokenを使用します。
        
        例: `Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...`
  schemas:
    TokenResponse:
      type: object
      required:
        - status
        - data
      properties:
        status:
          type: string
          description: レスポンスステータス
          enum: [success]
          example: "success"
        data:
          type: object
          required:
            - access_token
            - expires_at
            - ttl_seconds
            - refresh_token
            - refresh_expires_at
            - refresh_ttl_seconds
          properties:
            access_token:
              type: string
              description: 短命アクセス用のトークン（API呼び出しに使用）
              example: "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9..."
            expires_at:
              type: string
              format: date-time
              description: アクセストークンの有効期限 (UTC)
              example: "2026-01-18T12:30:00Z"
            ttl_seconds:
              type: integer
              description: アクセストークンの有効時間（秒）
              example: 3600
            refresh_token:
              type: string
              description: アクセストークン更新用のリフレッシュトークン
              example: "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9..."
            refresh_expires_at:
              type: string
              format: date-time
              description: リフレッシュトークンの有効期限 (UTC)
              example: "2026-02-17T11:30:00Z"
            refresh_ttl_seconds:
              type: integer
              description: リフレッシュトークンの有効時間（秒）
              example: 2592000

    QuestionRequest:
      type: object
      required:
        - question
      properties:
        application_id:
          type: integer
          nullable: true
          description: アプリケーションID（オプション）
          example: 1
        question:
          type: string
          description: 質問内容
          minLength: 1
          maxLength: 1000
          example: "この製品の使い方を教えてください"
      example:
        application_id: 1
        question: "この製品の使い方を教えてください"

    QuestionResponse:
      type: object
      required:
        - status
        - data
      properties:
        status:
          type: string
          description: レスポンスステータス
          enum: [success]
          example: "success"
        data:
          type: object
          required:
            - answer
          properties:
            answer:
              type: string
              description: LLMが生成した回答
              example: "製品の使い方については、以下の手順に従ってください..."
          description: レスポンスデータ（response_wrapperデコレーターによって自動的にラップされます）

    ErrorResponse:
      type: object
      required:
        - status
        - message
      properties:
        status:
          type: string
          description: レスポンスステータス
          enum: [error]
          example: "error"
        message:
          type: string
          description: エラーメッセージ
          example: "認証に失敗しました"
        error_code:
          type: string
          description: エラーコード
          example: "UNAUTHORIZED"
        details:
          type: object
          description: 詳細なエラー情報
          additionalProperties: true
          example:
            field: "question"
            reason: "必須項目です"

security:
  - bearerAuth: []